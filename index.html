<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureVault - Local Password Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind for Dark Mode utility classes -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Updated to match the specific blue/slate tones in the image
                        'primary': '#6366f1', 
                        'bg-dark': '#1f2937', // New dark blue/slate background
                        'card-dark': '#374151', // New softer card background
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS (Embedded from css/style.css) -->
    <style>
        /* Variables for easy theme switching (Updated to match Tailwind config) */
        :root {
            --primary: #6366f1;
            --bg-dark: #1f2937;
            --card-dark: #374151;
        }

        /* Base Styles: Ensures dark background and layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark); /* Guaranteed Dark Background */
            font-family: 'Inter', sans-serif;
            color: white; /* Ensure text is visible */
        }

        /* FIX: Hide browser's native password reveal button to prevent double icons */
        input::-ms-reveal,
        input::-webkit-reveal {
            display: none;
        }

        /* Card Background Fallback: Explicitly use the dark card variable */
        #loginScreen, #appScreen, #modalContent,
        .credential-item { 
            background-color: var(--card-dark);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* Scrollbar Styling for Password List */
        #passwordList::-webkit-scrollbar {
            width: 8px;
        }
        #passwordList::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        #passwordList::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        /* Input password type override for easy viewing in dev mode */
        .password-input:focus {
            -webkit-text-security: none !important;
            -moz-text-security: none !important;
            text-security: none !important;
        }

        .action-btn {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-bg-dark text-white font-sans h-full min-h-screen flex flex-col antialiased">

    <!-- 1. Authentication Screen (Hidden by default) -->
    <div id="loginScreen" class="fixed inset-0 bg-bg-dark flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm p-8 bg-card-dark rounded-xl shadow-2xl space-y-6">
            <h1 class="text-3xl font-bold text-center text-white">SecureVault</h1>
            <p class="text-center text-gray-400">Unlock your local vault with your Master Key.</p>
            
            <form id="loginForm" class="space-y-4">
                <div class="relative">
                    <input type="password" id="masterKey" placeholder="Enter Master Key" required
                           class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-white placeholder-gray-400 pr-10">
                    <button type="button" id="toggleMasterKeyBtn" 
                            class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"
                            aria-label="Toggle master key visibility">
                        <svg id="masterKeyEyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <!-- Default: Hidden state SVG (Closed Slit) -->
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 12v.01M6 12a6 6 0 0 1 12 0"/>
                        </svg>
                    </button>
                </div>
                <button type="submit" 
                        class="w-full py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors shadow-lg">
                    Unlock Vault
                </button>
                <p id="loginMessage" class="text-red-400 text-center hidden">Incorrect Master Key. Try again.</p>
            </form>
            
            <button id="resetVaultBtn" class="w-full text-sm text-gray-400 hover:text-red-400 transition-colors mt-4">
                Forgot Key? (Reset Vault)
            </button>
        </div>
    </div>

    <!-- 2. Main Application Screen -->
    <div id="appScreen" class="flex-grow flex flex-col hidden">
        
        <!-- Header / Controls -->
        <header class="bg-card-dark shadow-md p-4 sm:p-6 sticky top-0 z-40">
            <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <h1 class="text-2xl font-bold text-white">Your Credentials</h1>
                
                <div class="flex space-x-3 w-full sm:w-auto">
                    <input type="search" id="searchInput" placeholder="Search site or user..."
                           class="flex-grow px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:ring-primary focus:border-primary">
                    <button id="addNewBtn" 
                            class="flex-shrink-0 px-4 py-2 bg-primary hover:bg-indigo-600 text-white font-medium rounded-lg transition-colors shadow-md">
                        + Add New
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 sm:p-6 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div id="emptyState" class="text-center p-10 bg-card-dark rounded-xl shadow-lg mt-8 hidden">
                    <svg class="w-12 h-12 mx-auto text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v5a2 2 0 01-2 2h-4a2 2 0 01-2-2v-5a2 2 0 012-2h4z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 14H5c-1.104 0-2-.896-2-2V7c0-1.104.896-2 2-2h12v7"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18V9"></path></svg>
                    <h2 class="text-xl font-semibold text-white">Your Vault is Empty</h2>
                    <p class="text-gray-400">Click "Add New" to save your first credential securely.</p>
                </div>

                <!-- Password List -->
                <div id="passwordList" class="space-y-4 mt-4">
                    <!-- Credentials will be rendered here -->
                </div>
            </div>
        </main>

        <!-- Footer / Settings -->
        <footer class="bg-gray-800 p-4 shadow-inner sticky bottom-0 z-40">
            <div class="max-w-4xl mx-auto flex justify-between items-center text-sm text-gray-400">
                <span>SecureVault v1.0</span> 
                <div class="space-x-4">
                    <button id="changeKeyBtn" class="text-indigo-400 hover:text-indigo-300 transition-colors">Settings</button>
                    <button id="logoutBtn" class="text-red-400 hover:text-red-300 transition-colors">Lock Vault</button>
                </div>
            </div>
        </footer>
    </div>

    <!-- 3. Credential Modal (Add/Edit Form) -->
    <div id="credentialModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="w-full max-w-lg bg-card-dark rounded-xl shadow-2xl p-6 space-y-4">
            <h2 id="modalTitle" class="text-2xl font-bold text-white mb-4">Add New Credential</h2>
            
            <form id="credentialForm" class="space-y-4">
                <input type="hidden" id="credentialId">
                <input type="text" id="siteName" placeholder="Website / Service Name (e.g., Amazon)" required
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                <input type="url" id="urlInput" placeholder="Website URL (e.g., amazon.com)"
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                <input type="text" id="username" placeholder="Username or Email" required
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                
                <!-- Password Field with Generator and Visibility Toggle -->
                <div class="flex space-x-2">
                    <div class="relative w-full">
                        <input type="password" id="password" placeholder="Password" required
                               class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white password-input placeholder-gray-400 pr-10">
                        <button type="button" id="togglePasswordBtn" 
                                class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"
                                aria-label="Toggle password visibility">
                            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <!-- Default: Hidden state SVG (Closed Slit) -->
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 12v.01M6 12a6 6 0 0 1 12 0"/>
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="generateBtn" 
                            class="flex-shrink-0 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-lg transition-colors">
                        Generate
                    </button>
                </div>
                
                <!-- Password Strength Meter -->
                <div id="strengthContainer" class="pt-1">
                    <div class="h-1 bg-gray-600 rounded-full mb-1">
                        <div id="strengthBar" class="h-full rounded-full transition-all duration-300 w-0"></div>
                    </div>
                    <p id="strengthText" class="text-xs font-medium"></p>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelBtn" 
                            class="px-4 py-2 text-gray-400 hover:text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                        Save Credential
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 4. Change Master Key Modal -->
    <div id="changeKeyModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="w-full max-w-md bg-card-dark rounded-xl shadow-2xl p-6 space-y-4">
            <h2 class="text-2xl font-bold text-white mb-4">Change Master Key</h2>
            <form id="changeKeyForm" class="space-y-4">
                <p class="text-sm text-yellow-400">You must remember this new key. There is no recovery.</p>
                <input type="password" id="currentMasterKey" placeholder="Current Master Key" required
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                <input type="password" id="newMasterKey" placeholder="New Master Key" required
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                <input type="password" id="confirmNewMasterKey" placeholder="Confirm New Master Key" required
                       class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-primary text-white placeholder-gray-400">
                
                <p id="changeKeyMessage" class="text-red-400 text-center hidden"></p>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelChangeKeyBtn" 
                            class="px-4 py-2 text-gray-400 hover:text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors">
                        Update Key
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 5. Reset Vault Confirmation Modal -->
    <div id="resetVaultModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm bg-red-800 rounded-xl shadow-2xl p-6 space-y-4 border-2 border-red-600">
            <h2 class="text-xl font-bold text-white">⚠️ Erase All Data?</h2>
            <p class="text-sm text-red-100">This action is irreversible. All stored credentials and your Master Key will be permanently deleted from your browser's local storage.</p>
            <p class="text-sm text-red-100 font-semibold">Only proceed if you have forgotten your key.</p>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" id="cancelResetBtn" 
                        class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="button" id="confirmResetBtn" 
                        class="px-4 py-2 bg-white text-red-800 font-semibold rounded-lg transition-colors hover:bg-gray-200">
                    Yes, Erase Vault
                </button>
            </div>
        </div>
    </div>

    <!-- 6. Message Box (Non-blocking alerts) -->
    <div id="messageBox" class="hidden"></div>
    
    <!-- JavaScript Logic (Embedded from js/app.js) -->
    <script>
        // --- CONSTANTS AND STATE ---
        const MASTER_KEY_STORAGE_KEY = 'secureVaultMasterKey';
        const CREDENTIALS_STORAGE_KEY = 'secureVaultCredentials';
        let currentMasterKey = '';
        let credentials = [];
        let isEditing = false;
        let currentEditId = null;

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const loginForm = document.getElementById('loginForm');
        const masterKeyInput = document.getElementById('masterKey');
        const loginMessage = document.getElementById('loginMessage');

        const appScreen = document.getElementById('appScreen');
        const passwordList = document.getElementById('passwordList');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const logoutBtn = document.getElementById('logoutBtn');
        const addNewBtn = document.getElementById('addNewBtn');
        const messageBox = document.getElementById('messageBox');

        const credentialModal = document.getElementById('credentialModal');
        const modalTitle = document.getElementById('modalTitle');
        const credentialForm = document.getElementById('credentialForm');
        const credentialIdInput = document.getElementById('credentialId');
        const siteNameInput = document.getElementById('siteName');
        const urlInput = document.getElementById('urlInput');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const generateBtn = document.getElementById('generateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const changeKeyBtn = document.getElementById('changeKeyBtn');
        const resetVaultBtn = document.getElementById('resetVaultBtn');

        // New Strength Meter Elements
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');

        // New Toggle Visibility Elements
        const togglePasswordBtn = document.getElementById('togglePasswordBtn');
        const eyeIcon = document.getElementById('eyeIcon');
        
        // Master Key Toggle Elements
        const toggleMasterKeyBtn = document.getElementById('toggleMasterKeyBtn');
        const masterKeyEyeIcon = document.getElementById('masterKeyEyeIcon');
        
        // Change Key Modal Elements
        const changeKeyModal = document.getElementById('changeKeyModal');
        const changeKeyForm = document.getElementById('changeKeyForm');
        const currentMasterKeyInput = document.getElementById('currentMasterKey');
        const newMasterKeyInput = document.getElementById('newMasterKey');
        const confirmNewMasterKeyInput = document.getElementById('confirmNewMasterKey');
        const changeKeyMessage = document.getElementById('changeKeyMessage');
        const cancelChangeKeyBtn = document.getElementById('cancelChangeKeyBtn');

        // Reset Vault Modal Elements
        const resetVaultModal = document.getElementById('resetVaultModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');


        // --- UTILITY FUNCTIONS (Messaging, Encryption/Decryption) ---

        /**
         * Custom function to display a temporary notification message, replacing alert().
         */
        const showMessage = (text, type = 'success') => {
            messageBox.textContent = text;
            messageBox.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300';
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else if (type === 'info') {
                messageBox.classList.add('bg-indigo-600');
            }
            
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-indigo-600');
            }, 3000);
        };


        /**
         * Simple Base64 encoding/decoding for obfuscation.
         * NOTE: This is NOT secure encryption. It's for data obfuscation only.
         */
        const obfuscate = (text) => btoa(text);
        const deobfuscate = (base64) => {
            try {
                return atob(base64);
            } catch (e) {
                console.error("Deobfuscation error:", e);
                return '';
            }
        };

        const encryptData = (data, key) => {
            const dataString = JSON.stringify(data);
            return obfuscate(dataString);
        };

        const decryptData = (encryptedData, key) => {
            const dataString = deobfuscate(encryptedData);
            if (!dataString) return null;
            try {
                return JSON.parse(dataString);
            } catch (e) {
                console.error("JSON parsing error on decryption:", e);
                return null;
            }
        };

        // --- PASSWORD GENERATION ---
        const generatePassword = (length = 16) => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        };

        // --- PASSWORD STRENGTH LOGIC ---
        const checkPasswordStrength = (password) => {
            let score = 0;
            if (password.length >= 8) score += 10;
            if (password.length >= 12) score += 10;
            if (password.length >= 16) score += 10;
            
            const checks = {
                hasLowercase: /[a-z]/.test(password),
                hasUppercase: /[A-Z]/.test(password),
                hasNumbers: /[0-9]/.test(password),
                hasSymbols: /[^A-Za-z0-9]/.test(password)
            };

            const satisfiedChecks = Object.values(checks).filter(Boolean).length;
            score += satisfiedChecks * 15;

            score = Math.min(score, 100);

            let strength = 'Weak';
            let color = 'bg-red-500';
            
            if (score > 80) {
                strength = 'Strong';
                color = 'bg-green-500';
            } else if (score > 60) {
                strength = 'Good';
                color = 'bg-yellow-500';
            } else if (score > 40) {
                strength = 'Fair';
                color = 'bg-yellow-500'; 
            }
            
            return { score, strength, color };
        };

        const updateStrengthMeter = () => {
            const password = passwordInput.value;
            const { score, strength, color } = checkPasswordStrength(password);
            
            if (password.length === 0) {
                strengthBar.style.width = '0%';
                strengthBar.className = 'h-1 rounded-full transition-all duration-300';
                strengthText.textContent = '';
                return;
            }

            strengthBar.style.width = `${score}%`;
            strengthBar.className = `h-1 rounded-full transition-all duration-300 ${color}`;
            strengthText.textContent = `Strength: ${strength}`;
            
            if (score > 80) {
                strengthText.style.color = '#10b981'; // Green
            } else if (score > 60) {
                strengthText.style.color = '#f59e0b'; // Yellow
            } else {
                strengthText.style.color = '#ef4444'; // Red
            }
        };

        // --- DATA MANAGEMENT ---

        const loadCredentials = () => {
            const encryptedData = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            if (encryptedData) {
                const decrypted = decryptData(encryptedData, currentMasterKey);
                
                if (Array.isArray(decrypted)) {
                    credentials = decrypted;
                    return true;
                } else if (decrypted !== null) {
                    console.error("Stored credentials found but format is invalid. Clearing corrupted data.");
                    localStorage.removeItem(CREDENTIALS_STORAGE_KEY);
                    showMessage("Vault data was corrupted. Corrupted data cleared. Please add new credentials.", 'error');
                }
            }
            credentials = [];
            return true;
        };

        const saveCredentials = () => {
            const encryptedData = encryptData(credentials, currentMasterKey);
            localStorage.setItem(CREDENTIALS_STORAGE_KEY, encryptedData);
            renderCredentials();
        };

        // --- UI RENDERING ---

        const copyToClipboard = (text, element) => {
            const originalText = element.textContent;

            const handleSuccess = () => {
                element.textContent = 'Copied!';
                element.classList.remove('bg-green-500', 'hover:bg-green-600');
                element.classList.add('bg-indigo-500');

                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('bg-indigo-500');
                    element.classList.add('bg-green-500', 'hover:bg-green-600');
                }, 1500);
            };

            function tryExecCommand(textToCopy) {
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                textarea.style.position = 'fixed'; 
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        handleSuccess();
                    } else {
                        throw new Error("execCommand failed.");
                    }
                } catch (err) {
                    console.error('Could not copy text using execCommand (Fallback failed):', err);
                    showMessage('Copy failed. Manual copying required.', 'error');
                } finally {
                    document.body.removeChild(textarea);
                }
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    handleSuccess();
                }).catch(err => {
                    console.error('Modern copy API failed. Trying fallback:', err);
                    tryExecCommand(text);
                });
            } else {
                tryExecCommand(text);
            }
        };

        const copyPassword = (id, button) => {
            const credential = credentials.find(c => c.id === id);
            
            if (!credential || !credential.password) {
                showMessage("Error: Password data is incomplete or missing.", 'error');
                return;
            }
            
            const decryptedPass = deobfuscate(credential.password);
            
            if (!decryptedPass) {
                showMessage("Error: Could not retrieve or decrypt password.", 'error');
                return;
            }
            
            copyToClipboard(decryptedPass, button);
        };


        const createCredentialElement = (credential) => {
            const item = document.createElement('div');
            item.className = 'credential-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-700 hover:bg-gray-600 rounded-xl shadow-lg transition-all-200';
            item.dataset.id = credential.id;

            // Create the Site Name/Link element
            let siteNameDisplay;
            if (credential.url) {
                // Site Name is clickable if URL exists
                const safeUrl = credential.url.startsWith('http') ? credential.url : `https://${credential.url}`;
                siteNameDisplay = `<a href="${safeUrl}" target="_blank" class="text-lg font-semibold text-indigo-400 hover:text-indigo-300 transition-colors">${credential.siteName}</a>`;
            } else {
                // Site Name is just text if no URL
                siteNameDisplay = `<h3 class="text-lg font-semibold text-white truncate">${credential.siteName}</h3>`;
            }


            item.innerHTML = `
                <div class="flex flex-col mb-3 sm:mb-0 w-full sm:w-3/5">
                    ${siteNameDisplay}
                    <p class="text-sm text-gray-300 truncate">User: ${credential.username}</p>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-2/5 sm:justify-end">
                    <button data-action="copy" class="action-btn text-sm py-1 px-3 bg-green-500 hover:bg-green-600 rounded-md text-white font-medium transition-colors">Copy</button>
                    <button data-action="edit" class="action-btn text-sm py-1 px-3 bg-yellow-500 hover:bg-yellow-600 rounded-md text-white font-medium transition-colors">Edit</button>
                    <button data-action="delete" class="action-btn text-sm py-1 px-3 bg-red-500 hover:bg-red-600 rounded-md text-white font-medium transition-colors">Delete</button>
                </div>
            `;

            item.querySelectorAll('.action-btn').forEach(button => {
                const action = button.dataset.action;
                button.onclick = (e) => {
                    e.stopPropagation();
                    if (action === 'copy') {
                        copyPassword(credential.id, button);
                    } else if (action === 'edit') {
                        openModal(true, credential.id);
                    } else if (action === 'delete') {
                        deleteCredential(credential.id);
                    }
                };
            });

            return item;
        };

        const renderCredentials = (filter = '') => {
            passwordList.innerHTML = '';
            const lowerFilter = filter.toLowerCase();

            const filteredCredentials = credentials
                .filter(c => c.siteName.toLowerCase().includes(lowerFilter) || c.username.toLowerCase().includes(lowerFilter))
                .sort((a, b) => a.siteName.localeCompare(b.siteName));

            if (filteredCredentials.length === 0 && credentials.length > 0) {
                passwordList.innerHTML = `<p class="text-center text-gray-400 p-10">No results found for "${filter}".</p>`;
                emptyState.classList.add('hidden');
            } else if (credentials.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filteredCredentials.forEach(c => {
                    passwordList.appendChild(createCredentialElement(c));
                });
            }
        };

        // --- MODAL/FORM LOGIC ---

        const openModal = (edit = false, id = null) => {
            isEditing = edit;
            currentEditId = id;
            credentialForm.reset();
            
            // Set input type to password on open to ensure it is hidden first
            passwordInput.type = 'password'; 
            
            // Set eye icon to hidden state (Closed Slit)
            eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 12v.01M6 12a6 6 0 0 1 12 0"/>`;


            if (edit && id !== null) {
                const credential = credentials.find(c => c.id === id);
                if (credential) {
                    modalTitle.textContent = 'Edit Credential';
                    siteNameInput.value = credential.siteName;
                    urlInput.value = credential.url || '';
                    usernameInput.value = credential.username;
                    passwordInput.value = deobfuscate(credential.password);
                    credentialIdInput.value = id;
                }
            } else {
                modalTitle.textContent = 'Add New Credential';
            }
            
            updateStrengthMeter();

            credentialModal.classList.remove('hidden');
            credentialModal.classList.add('flex');
            siteNameInput.focus();
        };

        const closeModal = () => {
            credentialModal.classList.remove('flex');
            credentialModal.classList.add('hidden');
        };

        // --- TOGGLE PASSWORD VISIBILITY (Credential Input) ---
        const togglePasswordVisibility = () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                // Change icon to 'eye' (visible) - NO CROSS
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8Z" /><circle cx="12" cy="12" r="3"></circle>`;
            } else {
                passwordInput.type = 'password';
                // Change icon to 'eye-off' (hidden) - CLOSED SLIT
                eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 12v.01M6 12a6 6 0 0 1 12 0"/>`;
            }
        };

        // --- TOGGLE MASTER KEY VISIBILITY ---
        const toggleMasterKeyVisibility = () => {
            if (masterKeyInput.type === 'password') {
                masterKeyInput.type = 'text';
                // Change icon to 'eye' (visible) - NO CROSS
                masterKeyEyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8Z" /><circle cx="12" cy="12" r="3"></circle>`;
            } else {
                masterKeyInput.type = 'password';
                // Change icon to 'eye-off' (hidden) - CLOSED SLIT
                masterKeyEyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 12v.01M6 12a6 6 0 0 1 12 0"/>`;
            }
        };


        // --- CRUD OPERATIONS ---

        const deleteCredential = (id) => {
            credentials = credentials.filter(c => c.id !== id);
            saveCredentials();
            showMessage('Credential deleted successfully!', 'error'); 
        };

        credentialForm.onsubmit = (e) => {
            e.preventDefault();

            const siteName = siteNameInput.value.trim();
            const url = urlInput.value.trim();
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!siteName || !username || !password) return;

            const encryptedPassword = obfuscate(password);

            if (isEditing) {
                const index = credentials.findIndex(c => c.id === currentEditId);
                if (index !== -1) {
                    credentials[index] = {
                        ...credentials[index],
                        siteName,
                        url,
                        username,
                        password: encryptedPassword
                    };
                    showMessage('Credential updated!', 'success');
                }
            } else {
                const newCredential = {
                    id: Date.now().toString(),
                    siteName,
                    url,
                    username,
                    password: encryptedPassword
                };
                credentials.push(newCredential);
                showMessage('Credential added successfully!', 'success');
            }

            saveCredentials();
            closeModal();
        };

        // --- MASTER KEY / AUTHENTICATION LOGIC ---

        const simpleHash = (s) => s.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);

        const checkMasterKey = (key) => {
            const storedKeyHash = localStorage.getItem(MASTER_KEY_STORAGE_KEY);
            const inputHash = simpleHash(key).toString();

            if (!storedKeyHash) {
                localStorage.setItem(MASTER_KEY_STORAGE_KEY, inputHash);
                return true;
            }

            if (inputHash !== storedKeyHash) {
                console.error(`Login failed. Stored hash: ${storedKeyHash} | Input hash: ${inputHash}`);
            }

            return inputHash === storedKeyHash;
        };

        const authenticate = () => {
            loginScreen.classList.add('hidden');
            appScreen.classList.add('hidden');
            changeKeyModal.classList.add('hidden');
            resetVaultModal.classList.add('hidden');

            if (!currentMasterKey) {
                loginScreen.classList.remove('hidden');
                masterKeyInput.focus();
                return;
            }

            if (loadCredentials()) {
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                renderCredentials();
            } else {
                showMessage("Error decrypting data. Please log in again.", 'error');
                currentMasterKey = '';
                authenticate();
            }
        };

        // --- MASTER KEY CHANGE LOGIC ---

        const openChangeKeyModal = () => {
            changeKeyForm.reset();
            changeKeyMessage.classList.add('hidden');
            changeKeyModal.classList.remove('hidden');
            changeKeyModal.classList.add('flex');
            currentMasterKeyInput.focus();
        };

        const closeChangeKeyModal = () => {
            changeKeyModal.classList.add('hidden');
        };

        changeKeyForm.onsubmit = (e) => {
            e.preventDefault();
            changeKeyMessage.classList.add('hidden');
            
            const currentKey = currentMasterKeyInput.value.trim();
            const newKey = newMasterKeyInput.value.trim();
            const confirmKey = confirmNewMasterKeyInput.value.trim();

            if (!currentKey || !newKey || !confirmKey) {
                changeKeyMessage.textContent = 'All fields are required.';
                changeKeyMessage.classList.remove('hidden');
                return;
            }
            
            if (newKey !== confirmKey) {
                changeKeyMessage.textContent = 'New keys do not match.';
                changeKeyMessage.classList.remove('hidden');
                return;
            }

            if (!checkMasterKey(currentKey)) {
                changeKeyMessage.textContent = 'Current Master Key is incorrect.';
                changeKeyMessage.classList.remove('hidden');
                return;
            }

            if (currentKey === newKey) {
                changeKeyMessage.textContent = 'New key must be different from the current key.';
                changeKeyMessage.classList.remove('hidden');
                return;
            }

            // Since the current key is correct, we proceed with re-encryption
            const oldKey = currentMasterKey;
            const newHash = simpleHash(newKey).toString();

            // 1. Re-encrypt all credentials using the new key
            const reEncryptedCredentials = credentials.map(c => ({
                ...c,
                password: encryptData(deobfuscate(c.password), newKey)
            }));

            credentials = reEncryptedCredentials;
            currentMasterKey = newKey; // Update current running key

            // 2. Save the newly hashed master key and re-encrypted data
            localStorage.setItem(MASTER_KEY_STORAGE_KEY, newHash);
            saveCredentials(); 

            closeChangeKeyModal();
            showMessage('Master Key changed successfully!', 'success');
        };


        // --- RESET VAULT LOGIC (Forgot Key) ---

        const openResetVaultModal = () => {
            resetVaultModal.classList.remove('hidden');
            resetVaultModal.classList.add('flex');
        };

        const closeResetVaultModal = () => {
            resetVaultModal.classList.add('hidden');
        };

        const resetVault = () => {
            localStorage.removeItem(MASTER_KEY_STORAGE_KEY);
            localStorage.removeItem(CREDENTIALS_STORAGE_KEY);
            
            closeResetVaultModal();
            currentMasterKey = '';
            showMessage('Vault has been reset. Please set a new Master Key.', 'error');
            authenticate();
        };


        // --- EVENT LISTENERS ---

        loginForm.onsubmit = (e) => {
            e.preventDefault();
            const key = masterKeyInput.value.trim();

            if (checkMasterKey(key)) {
                currentMasterKey = key;
                loginMessage.classList.add('hidden');
                masterKeyInput.value = '';
                authenticate();
            } else {
                loginMessage.textContent = 'Incorrect Master Key. Try again.';
                loginMessage.classList.remove('hidden');
                masterKeyInput.value = '';
                masterKeyInput.focus();
            }
        };

        logoutBtn.onclick = () => {
            currentMasterKey = '';
            masterKeyInput.value = '';
            authenticate();
        };

        addNewBtn.onclick = () => openModal(false);
        cancelBtn.onclick = closeModal;

        generateBtn.onclick = () => {
            passwordInput.value = generatePassword();
            updateStrengthMeter();
        };

        passwordInput.oninput = updateStrengthMeter;
        togglePasswordBtn.onclick = togglePasswordVisibility; // Credential password toggle

        toggleMasterKeyBtn.onclick = toggleMasterKeyVisibility; // Master Key password toggle

        searchInput.oninput = (e) => {
            renderCredentials(e.target.value);
        };

        credentialModal.addEventListener('click', (e) => {
            if (e.target.id === 'credentialModal') {
                closeModal();
            }
        });

        // Master Key Management Listeners
        changeKeyBtn.onclick = openChangeKeyModal;
        cancelChangeKeyBtn.onclick = closeChangeKeyModal;
        resetVaultBtn.onclick = openResetVaultModal;
        cancelResetBtn.onclick = closeResetVaultModal;
        confirmResetBtn.onclick = resetVault;

        // Initialize the app state
        authenticate();
    </script>
</body>
</html>
